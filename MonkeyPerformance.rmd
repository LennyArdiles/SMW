---
title: "The Performance of 10,000 Monkeys"
author: "Rex Macey"
date: "November 17, 2015"
output: html_document
---
```{r echo=FALSE, message=FALSE, warning=FALSE}
setwd("C:/Users/Rex/Documents/Quant Trading/SMW")
source("SMWUtilities.r")
library(SDMTools)
init_environment()
n.monkeys<-10000
Y_M<-1
n.months<-length(sipbInstallDates)-Y_M
n.stocks<-50
set.seed(101)
#1 / x.df$PRCHG_SD3Y[sort.idx]
Month_Perform<-function(i,n.monkeys,n.stocks){
    xy<-combine_xy(i,Y_M)[,c("SP","MKTCAP","PRCHG_SD3Y","YRet")]
    riskwts<-xy$PRCHG_SD3Y
    riskwts[is.na(riskwts)]<-mean(riskwts,na.rm = TRUE)
    sp.idx<-xy$SP=="500"
    sp.ret<-weighted.mean(xy$YRet[sp.idx],xy$MKTCAP[sp.idx])
    cwu.ret<-weighted.mean(xy$YRet,xy$MKTCAP)
    rwu.ret<-weighted.mean(xy$YRet,1/riskwts)
    ewu.ret<-mean(xy$YRet)
    
    OneMonkey<-function(xy,n.stocks){
        eqmonkey.idx<-sample.int(nrow(xy),n.stocks)
        eqmonkey.ret<-mean(xy$YRet[eqmonkey.idx])
        cwmonkey.ret<-weighted.mean(xy$YRet[eqmonkey.idx],xy$MKTCAP[eqmonkey.idx])
        rwmonkey.ret<-weighted.mean(xy$YRet[eqmonkey.idx],1/riskwts[eqmonkey.idx])
        return(c(eqmonkey=eqmonkey.ret,cwmonkey=cwmonkey.ret,rwmonkey=rwmonkey.ret))
    }
    monkey<-replicate(n.monkeys,OneMonkey(xy,n.stocks))
    return(c(sp=sp.ret,equ=ewu.ret,cwu=cwu.ret,rwu=rwu.ret,
             eqmonkey=monkey[1,],cwmonkey=monkey[2,],rwmonkey=monkey[3,]))
}
if (FALSE){ # Set to true to recalc universe, false to load from file.
    Universe<-lapply(1:n.months,Month_Perform,n.monkeys=n.monkeys,n.stocks=n.stocks)
    names(Universe)<-sipbInstallDates[1:n.months]
    Universe<-do.call(rbind,Universe)
    saveRDS(Universe,file="RandomMonkeys.rds")    
} else {
    Universe=readRDS("RandomMonkeys.rds")
}
eq.idx<-5:(n.monkeys+4)
cw.idx<-eq.idx+n.monkeys
rw.idx<-cw.idx+n.monkeys
ret<-100*(apply(1+Universe/100,2,prod)^(12/nrow(Universe))-1)
library(PerformanceAnalytics)
dd<-maxDrawdown(Universe/100)*100
```

Is the performance of a stock mutual fund (or manager or model) better than chance? How could we decide?  What follows is a simple description of a method even non-statisticians can appreciate. We'll also learn something about portfolio weighting.  Turns out we can learn a lot from "monkeys".

Imagine teaching `r format(n.monkeys,digits=6)` monkeys each to throw `r n.stocks` darts at a list of all the
stocks in our universe which is about 3000 stocks all with prices of at least $5/share and a market capitalization of $250 million. We don't have that many monkeys but a computer can randomly pick stocks which is as good and faster. This gives us a set of `r format(n.monkeys,digits=6)` portfolios of `r n.stocks` stocks created by chance.  If our fund is in the top 5% of the universe, one interpretation of that would be that there is a 5% chance that through just luck we could have ended up with such a portfolio. 

One crucial caveat is that this logic applies to the evaluation of one portfolio. While an individual fund may have a 5% chance of such performance, if we create 1000 portfolios or look at 1000 funds, there's a much higher probability that the best of the 1000 will.  So we must be careful. Across the many funds out there, the laws of chance dictate some will do well. 

There's another interesting question that we address as we create this universe.  Once one of
our virtual monkeys picks `r n.stocks` stocks, how should we weight them?  We're going to look at three weighting schemes: equal weighted, weighted by market capitalization, and weighted by the inverse of the risk as measured by price volatility over the last three years.  

The following table and chart show the distribution of the `r format(n.monkeys,digits=6)` returns for the three weighting methods.

```{r echo=FALSE, comment=""}
summarytbl<-rbind(summary(ret[eq.idx]),summary(ret[cw.idx]),summary(ret[rw.idx]))
row.names(summarytbl)<-c("Equal","Cap","Risk")
print(round(summarytbl,2))
par(mfrow=c(2,2))
hist(ret[eq.idx],col=rgb(1,0,0,0.5),main="Equal Weighted",xlab="Return",ylab="Freq. (#Monkeys)",
     xlim=c(-2,18),ylim=c(0,2500))
hist(ret[cw.idx],col=rgb(0,0,1,0.5),main="Cap Weighted",xlab="Return",ylab="Freq. (#Monkeys)",
     xlim=c(-2,18),ylim=c(0,2500))
hist(ret[rw.idx],col=rgb(0,1,0,0.5),main="Risk Weighted",xlab="Return",ylab="Freq. (#Monkeys)",
     xlim=c(-2,18),ylim=c(0,2500))
hist(ret[eq.idx],col=rgb(1,0,0,0.5),main="Combined",xlab="Return",ylab="Freq. (#Monkeys)",
     xlim=c(-2,18),ylim=c(0,2500))
hist(ret[cw.idx],col=rgb(0,0,1,0.5),add=T)
hist(ret[rw.idx],col=rgb(0,1,0,0.5),add=T)
par(mfrow=c(1,1))
```

The best average returns are generated by equal weighting. The best minimumn returns are produced by risk weighting.  The worst minimumn returns and best maximum returns are produced by the capitalization weighting. In other words, cap-weighting has the greatest dispersion, and risk-weighting has the least.  

It may seem odd that giving more weighting to large companies, generally thought to be less risky, seems riskier. The explanation for this is that in a randomly chosen `r n.stocks` stock portfolio we may be giving a lot of weight to a few companies, thereby increasing risk.

The following chart shows the same data in a different form to help us decide if one weighting scheme is preferable.  We order the returns of the three sets of `r format(n.monkeys,digits=6)` returns from best to worst. The green line is the capitalization weighted portfolios.  While it has the single highest return, there's only about a 10% chance it will be the best and about an 80% chance it will be the worst.  The red is the risk-weighted.  It has the best of the worst returns.  But this is only useful 1 in `r format(n.monkeys,digits=6)` observations.  Most of the time the (blue) equal weighted portfolio can be expected to outperform the others.  It may be that larger companies have less risk and thus risk weighting tends to weight larger companies more.

```{r echo=FALSE}
eqsort<-ret[eq.idx]
eqsort<-eqsort[order(eqsort,decreasing=TRUE)]
rwsort<-ret[rw.idx]
rwsort<-rwsort[order(rwsort,decreasing=TRUE)]
cwsort<-ret[cw.idx]
cwsort<-cwsort[order(cwsort,decreasing=TRUE)]
plot(cwsort,main="Sorted Returns by Weighting Scheme",ylab="Return",xlab="Monkey",col="green",
    type="l")
lines(eqsort, col="blue")
lines(rwsort, col="red")
```

Returning to the original issue of considering the chance of performance being due to luck or skill, we consider one more chart. Each point in the gray cloud represents the performance of one monkey.  We add various indices.  The boxplots along the axes show the dispersion. Comparing performance against the universe gives a fair idea of how lucky a manager would have to be to achieve his or her results by chance. In this case, there is a 5% chance of returning `r format(eqsort[floor(n.monkeys*.05)],digits=2,nsmall=2)`% which is `r format(eqsort[floor(n.monkeys*.05)] - mean(eqsort),digits=2,nsmall=2)` above the average of `r format(mean(eqsort), digits=2,nsmall=2)`.  
```{r echo=FALSE}
plot(dd[eq.idx],ret[eq.idx],col="lightgray",xlim=c(0,100),
     ylim=c(min(ret[eq.idx]),max(ret[eq.idx])),
     main="Equal Weighted",ylab="Annual Return",xlab="Maximum Drawdown")
points(dd[1],ret[1],col="blue",pch=19)
points(dd[2],ret[2],col="black",pch=19)
points(dd[3],ret[3],col="red",pch=19)
abline(v=median(dd[eq.idx]),col="gray")
abline(h=median(ret[eq.idx]),col="gray")
legend(x="topleft",legend=c("S&P","Universe-Equal Wt","Universe-Cap Wt","Monkey","Boxplot"),
       col=c("blue","black","red","lightgray","yellow"),pch=c(19,19,19,1))
boxplot(ret[eq.idx],add=T,col="yellow",varwidth = T,notch = T,at=100,outline = F)
boxplot(dd[eq.idx],add=T,col="yellow",varwidth = T,notch = T,at=min(ret[eq.idx]),
        horizontal=T,outline = F)
```

The returns used in this analysis are price-only returns from `r format(as.Date(sipbInstallDates[2],"%Y%m%d"),"%B %Y")` to `r  format(as.Date(sipbInstallDates[n.months+1],"%Y%m%d"),"%B %Y")`
